<script>
function login(){
const u=document.getElementById('usuario').value;
const s=document.getElementById('senha').value;
if(u==='admin'&&s==='1234'){
document.getElementById('loginBox').classList.add('hidden');
document.getElementById('appBox').classList.remove('hidden');
}else{
alert('Usuário ou senha incorretos');
}
}

let relatorioTexto="";

// ================= FUNÇÕES TÉCNICAS =================

// Perda de carga Hazen-Williams (mca)
function perdaCargaHW(Q_m3h,D_mm,L_m){
if(Q_m3h<=0) return 0;
const Q=Q_m3h/3600; // m³/s
const D=D_mm/1000;  // m
const C=140; // PEAD
return 10.67*L_m*Math.pow(Q,1.852)/
       (Math.pow(C,1.852)*Math.pow(D,4.87));
}

// escolhe diâmetro pela velocidade máxima (~1.5 m/s)
function escolherDiametro(Q_m3h){
const lista=[25,32,40,50,63,75];
for(let d of lista){
const area=Math.PI*Math.pow(d/1000,2)/4;
const v=(Q_m3h/3600)/area;
if(v<=1.5) return d;
}
return 75;
}

// ETc simplificada (mm/dia)
function calcularETc(cultura,clima){
let eto=4;

if(clima==='semiarido') eto=7;
else if(clima==='tropical') eto=5;
else if(clima==='equatorial') eto=6;
else if(clima==='temperado') eto=4;

const kc={
milho:1.15, soja:1.10, tomate:1.15,
alface:1.00, feijao:1.05, banana:1.20
};

return eto*(kc[cultura]||1.0);
}

function calcularSistema(){

const potenciaDisponivel=parseFloat(document.getElementById('potencia').value);
const distancia=parseFloat(document.getElementById('distancia').value);
const cultura=document.getElementById('cultura').value;
const fileiras=parseInt(document.getElementById('fileiras').value);
const comprimento=parseFloat(document.getElementById('comprimento').value);
const clima=document.getElementById('clima').value;
const nomeProdutor=document.getElementById('nomeProdutor').value;
const nomeAgronomo=document.getElementById('nomeAgronomo').value;
const cidade=document.getElementById('cidade').value;
const municipio=document.getElementById('municipio').value;
const precoEnergia=parseFloat(document.getElementById('precoEnergia').value);

if([potenciaDisponivel,distancia,fileiras,comprimento,precoEnergia].some(isNaN)||!nomeProdutor||!nomeAgronomo||!cidade||!municipio){
alert('Preencha todos os campos corretamente');
return;
}

// ===== Cultura =====
let vazaoPlanta=2;
let espacamento=0.3;

if(cultura==='alface'){vazaoPlanta=2;espacamento=0.30;}
else if(cultura==='tomate'){vazaoPlanta=4;espacamento=0.40;}
else if(cultura==='cenoura'){vazaoPlanta=1.2;espacamento=0.25;}
else if(cultura==='cebola'){vazaoPlanta=1.0;espacamento=0.20;}
else if(cultura==='batata'){vazaoPlanta=2.5;espacamento=0.35;}
else if(cultura==='pepino'){vazaoPlanta=3;espacamento=0.50;}
else if(cultura==='pimentao'){vazaoPlanta=3.5;espacamento=0.50;}
else if(cultura==='couve'){vazaoPlanta=2.2;espacamento=0.60;}
else if(cultura==='beterraba'){vazaoPlanta=1.3;espacamento=0.30;}
else if(cultura==='rucula'){vazaoPlanta=0.8;espacamento=0.20;}
else if(cultura==='laranja'){vazaoPlanta=40;espacamento=4;}
else if(cultura==='limao'){vazaoPlanta=35;espacamento=4;}
else if(cultura==='manga'){vazaoPlanta=60;espacamento=6;}
else if(cultura==='goiaba'){vazaoPlanta=30;espacamento=4;}
else if(cultura==='mamao'){vazaoPlanta=15;espacamento=2.5;}
else if(cultura==='banana'){vazaoPlanta=20;espacamento=3;}
else if(cultura==='morango'){vazaoPlanta=1.5;espacamento=0.25;}
else if(cultura==='melancia'){vazaoPlanta=5;espacamento=2;}
else if(cultura==='melao'){vazaoPlanta=4;espacamento=1.5;}
else if(cultura==='abacaxi'){vazaoPlanta=2;espacamento=0.40;}
else if(cultura==='milho'){vazaoPlanta=3.5;espacamento=0.50;}
else if(cultura==='soja'){vazaoPlanta=2.5;espacamento=0.45;}
else if(cultura==='arroz'){vazaoPlanta=6;espacamento=0.30;}
else if(cultura==='trigo'){vazaoPlanta=2;espacamento=0.20;}
else if(cultura==='feijao'){vazaoPlanta=2.8;espacamento=0.40;}

// ===== Cálculos =====
const plantasPorFileira=Math.max(1,Math.floor(comprimento/espacamento));
const totalPlantas=plantasPorFileira*fileiras;

const vazaoTotal=totalPlantas*vazaoPlanta;
const vazao_m3h=vazaoTotal/1000;

// área aproximada (m²)
const espacamentoLinhas=0.8;
const area=fileiras*comprimento*espacamentoLinhas;

// ETc e tempo de irrigação
const etc=calcularETc(cultura,clima);
const volumeDia=(etc/1000)*area; // m³/dia
let tempoIrrigacao=volumeDia/(vazao_m3h||1);
if(!isFinite(tempoIrrigacao)||tempoIrrigacao<0.5) tempoIrrigacao=0.5;

// ===== Hidráulica =====
const diametro=escolherDiametro(vazao_m3h);
const perdaCarga=perdaCargaHW(vazao_m3h,diametro,distancia);

const HMT=12+(distancia*0.01)+perdaCarga;

// potência com eficiência real
const eficiencia=0.65;
const potenciaNecessaria=(vazao_m3h*HMT)/(75*eficiencia);

// seleção bomba
let bombaSugerida="";
if(potenciaNecessaria<=0.5) bombaSugerida="Bomba 0,5 CV";
else if(potenciaNecessaria<=1) bombaSugerida="Bomba 1 CV";
else if(potenciaNecessaria<=2) bombaSugerida="Bomba 2 CV";
else if(potenciaNecessaria<=3) bombaSugerida="Bomba 3 CV";
else bombaSugerida="Bomba acima de 3 CV";

// tubo real
const tuboPrincipal=diametro+"mm PEAD";

// método
let metodoIrrigacao="";
if(cultura==='alface'||cultura==='tomate'||cultura==='morango'||cultura==='pepino'||cultura==='rucula'){
metodoIrrigacao="Gotejamento";
}else{
metodoIrrigacao="Aspersão";
}

// ===== Energia (CORRIGIDO) =====
const kW=potenciaNecessaria*0.7355;
const custoEnergia=(kW*tempoIrrigacao*30*precoEnergia).toFixed(2);

// ===== Relatório =====
relatorioTexto=`Projeto de Irrigação - AgroCalc Pro

Produtor: ${nomeProdutor}
Engenheiro Agrônomo: ${nomeAgronomo}
Cidade: ${cidade} / ${municipio}

Cultura: ${cultura}
Total de plantas: ${Math.round(totalPlantas)}
Vazão total: ${Math.round(vazaoTotal)} L/h

--- Dimensionamento Hidráulico ---
Perda de carga estimada: ${perdaCarga.toFixed(2)} mca
Altura manométrica total (HMT): ${HMT.toFixed(2)} mca
Potência hidráulica requerida: ${potenciaNecessaria.toFixed(2)} CV
Bomba sugerida: ${bombaSugerida}
Tubulação principal: ${tuboPrincipal}
Mangueira secundária: 16mm
Pressão recomendada: 10 a 15 mca
Método de irrigação recomendado: ${metodoIrrigacao}
Tempo diário estimado de operação: ${tempoIrrigacao.toFixed(2)} h/dia
Custo mensal estimado de energia: R$ ${custoEnergia}

Observação: Conferir curva real da bomba para validação final.`;

// mostrar tela
document.getElementById('resultadoTela').innerHTML=relatorioTexto.replace(/\n/g,'<br>');
document.getElementById('appBox').classList.add('hidden');
document.getElementById('resultadoBox').classList.remove('hidden');
}

function voltarProjeto(){
document.getElementById('resultadoBox').classList.add('hidden');
document.getElementById('appBox').classList.remove('hidden');
}

async function gerarPDF(){
if(!relatorioTexto){alert('Calcule o projeto primeiro');return;}
const { jsPDF } = window.jspdf;
const doc=new jsPDF();
const linhas=doc.splitTextToSize(relatorioTexto,180);
doc.text(linhas,10,10);
doc.save('Projeto_Irrigacao_AgroCalc.pdf');
}
</script>