// ==================== INTEGRAÇÃO DE CLIMA EM TEMPO REAL ====================
// Ajusta recomendações de irrigação com base na localização do usuário
async function obterClima() {
    if (!navigator.geolocation) {
        alert("Geolocalização não suportada no seu navegador.");
        return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        try {
            // Usando Open-Meteo (API gratuita) para obter clima
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relative_humidity_2m,precipitation`);
            const data = await response.json();
            const climaAtual = data.current_weather;

            // Ajustes simples de recomendação baseados em clima
            const temp = climaAtual.temperature;
            const umidade = climaAtual.windspeed; // pode usar outro campo se disponível
            const precip = climaAtual.precipitation;

            let ajusteVazao = 1; // fator de ajuste
            let recomendacaoClima = "Normal";

            if (temp > 30 || umidade < 40) {
                ajusteVazao = 1.2;
                recomendacaoClima = "Aumentar irrigação devido a calor ou baixa umidade";
            } else if (precip > 5) {
                ajusteVazao = 0.8;
                recomendacaoClima = "Reduzir irrigação devido a chuvas recentes";
            }

            // Atualizar relatório se já tiver sido calculado
            if (relatorioTexto) {
                relatorioTexto += `

--- Ajuste baseado em clima ---
Temperatura atual: ${temp} °C
Precipitação prevista: ${precip} mm
Recomendação: ${recomendacaoClima}
Fator de ajuste de vazão: ${ajusteVazao}x`;
                
                document.getElementById('resultadoTela').innerHTML = relatorioTexto.replace(/\n/g,'<br>');
            }

        } catch (err) {
            console.error("Erro ao obter clima:", err);
        }

    }, (erro) => {
        console.warn(`Erro na geolocalização: ${erro.message}`);
    });
}

// ==================== EXECUTA O CLIMA APÓS CALCULAR SISTEMA ====================
const botaoCalcular = document.querySelector("button[onclick='calcularSistema()']");
botaoCalcular.addEventListener("click", () => {
    setTimeout(obterClima, 500); // obtém clima logo após cálculo
});