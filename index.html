<script>
function login(){
const u=document.getElementById('usuario').value;
const s=document.getElementById('senha').value;
if(u==='admin'&&s==='1234'){
document.getElementById('loginBox').classList.add('hidden');
document.getElementById('appBox').classList.remove('hidden');
}else{alert('Usu√°rio ou senha incorretos');}
}

let relatorioTexto="";
let etoAtual=4.5; // valor padr√£o se n√£o carregar clima

// ================= BASE T√âCNICA (inspirada Embrapa) =================
const baseCulturas={
alface:{kc:0.95,vazao:2,esp:0.30},
tomate:{kc:1.15,vazao:4,esp:0.40},
cenoura:{kc:0.85,vazao:1.2,esp:0.25},
cebola:{kc:0.85,vazao:1.0,esp:0.20},
batata:{kc:1.05,vazao:2.5,esp:0.35},
pepino:{kc:1.0,vazao:3,esp:0.50},
pimentao:{kc:1.05,vazao:3.5,esp:0.50},
couve:{kc:0.95,vazao:2.2,esp:0.60},
beterraba:{kc:0.9,vazao:1.3,esp:0.30},
rucula:{kc:0.8,vazao:0.8,esp:0.20},
laranja:{kc:0.9,vazao:40,esp:4},
limao:{kc:0.9,vazao:35,esp:4},
manga:{kc:1.0,vazao:60,esp:6},
goiaba:{kc:0.95,vazao:30,esp:4},
mamao:{kc:1.1,vazao:15,esp:2.5},
banana:{kc:1.2,vazao:20,esp:3},
morango:{kc:0.85,vazao:1.5,esp:0.25},
melancia:{kc:1.05,vazao:5,esp:2},
melao:{kc:1.0,vazao:4,esp:1.5},
abacaxi:{kc:0.9,vazao:2,esp:0.40},
milho:{kc:1.15,vazao:3.5,esp:0.50},
soja:{kc:1.1,vazao:2.5,esp:0.45},
arroz:{kc:1.2,vazao:6,esp:0.30},
trigo:{kc:1.05,vazao:2,esp:0.20},
feijao:{kc:1.1,vazao:2.8,esp:0.40}
};

const nomesCultura=Object.fromEntries(
Object.keys(baseCulturas).map(k=>[k,k.charAt(0).toUpperCase()+k.slice(1)])
);

// ================= CLIMA EM TEMPO REAL =================
async function obterClima(){

if(!navigator.geolocation){
alert("Geolocaliza√ß√£o n√£o suportada");
return;
}

document.getElementById('climaInfo').classList.remove('hidden');
document.getElementById('climaInfo').innerHTML="Obtendo localiza√ß√£o...";

navigator.geolocation.getCurrentPosition(async pos=>{
const lat=pos.coords.latitude;
const lon=pos.coords.longitude;

try{
const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;
const resp=await fetch(url);
const dados=await resp.json();

const temp=dados.current_weather.temperature;
const vento=dados.current_weather.windspeed;

// estimativa simplificada de ETo (modelo emp√≠rico)
etoAtual=(0.0023*(temp+17)*(Math.sqrt(vento+1))*15);

document.getElementById('climaInfo').innerHTML=
`üìç Local detectado<br>
üå°Ô∏è Temperatura: ${temp} ¬∞C<br>
üí® Vento: ${vento} km/h<br>
üìä ETo estimada: ${etoAtual.toFixed(2)} mm/dia`;

}catch(e){
document.getElementById('climaInfo').innerHTML="Erro ao obter clima ‚Äî usando valor padr√£o.";
}
});
}

// ================= C√ÅLCULO PRINCIPAL =================
function calcularSistema(){

const potencia=parseFloat(document.getElementById('potencia').value);
const distancia=parseFloat(document.getElementById('distancia').value);
const cultura=document.getElementById('cultura').value;
const fileiras=parseInt(document.getElementById('fileiras').value);
const comprimento=parseFloat(document.getElementById('comprimento').value);

if(isNaN(potencia)||isNaN(distancia)||isNaN(fileiras)||isNaN(comprimento)){
alert('Preencha todos os campos corretamente');
return;
}

const base=baseCulturas[cultura];

const plantasPorFileira=Math.floor(comprimento/base.esp);
const totalPlantas=plantasPorFileira*fileiras;
const vazaoTotal=totalPlantas*base.vazao;
const vazaoLinha=vazaoTotal/fileiras;

// ======= ETc PROFISSIONAL =======
const etc=etoAtual*base.kc;
const laminaBruta=etc/0.9;

let tuboPrincipal='25mm';
if(potencia>=2||distancia>200) tuboPrincipal='40mm';
else if(potencia>=1) tuboPrincipal='32mm';

relatorioTexto=`Projeto de Irriga√ß√£o - AgroCalc Pro

Cultura: ${nomesCultura[cultura]}
ETo utilizada: ${etoAtual.toFixed(2)} mm/dia
ETc estimada: ${etc.toFixed(2)} mm/dia
L√¢mina bruta: ${laminaBruta.toFixed(2)} mm/dia

Total de plantas: ${Math.round(totalPlantas)}
Vaz√£o por linha: ${vazaoLinha.toFixed(1)} L/h
Vaz√£o total: ${Math.round(vazaoTotal)} L/h

Tubula√ß√£o principal: ${tuboPrincipal}
Mangueira secund√°ria: 16mm
Press√£o recomendada: 10 a 15 mca

Base t√©cnica inspirada em recomenda√ß√µes da Embrapa.
Validar projeto hidr√°ulico final em campo.`;

document.getElementById('resultado').classList.remove('hidden');
document.getElementById('resultado').innerHTML=relatorioTexto.replace(/\n/g,'<br>');
}

// ================= PDF =================
async function gerarPDF(){
if(!relatorioTexto){alert('Calcule o projeto primeiro');return;}
const { jsPDF } = window.jspdf;
const doc=new jsPDF();
const linhas=doc.splitTextToSize(relatorioTexto,180);
doc.text(linhas,10,10);
doc.save('Projeto_Irrigacao_AgroCalc.pdf');
}
</script>