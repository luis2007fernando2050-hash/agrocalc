<script>
function login(){
const u=document.getElementById('usuario').value;
const s=document.getElementById('senha').value;
if(u==='admin'&&s==='1234'){
document.getElementById('loginBox').classList.add('hidden');
document.getElementById('appBox').classList.remove('hidden');
}else{
alert('Usuário ou senha incorretos');
}
}

let relatorioTexto="";

// ===============================
// FUNÇÕES TÉCNICAS NOVAS
// ===============================

// Hazen-Williams (perda de carga em mca)
function perdaCargaHazenWilliams(Q_m3h, D_mm, L_m){
const Q = Q_m3h/3600; // m³/s
const D = D_mm/1000;  // m
const C = 140; // PEAD
return 10.67 * L_m * Math.pow(Q,1.852) /
       (Math.pow(C,1.852) * Math.pow(D,4.87));
}

// escolhe diâmetro pela velocidade recomendada
function escolherDiametro(Q_m3h){
const diametros=[25,32,40,50,63,75];
for(let d of diametros){
const area=Math.PI*Math.pow(d/1000,2)/4;
const v=(Q_m3h/3600)/area;
if(v<=1.5) return d;
}
return 75;
}

// ETc simplificada (mm/dia)
function etcEstimado(cultura,clima){
let base=4;

if(clima==='semiarido') base=7;
else if(clima==='tropical') base=5;
else if(clima==='equatorial') base=6;
else if(clima==='temperado') base=4;

const kc={
milho:1.15, soja:1.1, tomate:1.15,
alface:1.0, feijao:1.05, banana:1.2
};

return base*(kc[cultura]||1.0);
}

function calcularSistema(){

const potenciaDisponivel=parseFloat(document.getElementById('potencia').value);
const distancia=parseFloat(document.getElementById('distancia').value);
const cultura=document.getElementById('cultura').value;
const fileiras=parseInt(document.getElementById('fileiras').value);
const comprimento=parseFloat(document.getElementById('comprimento').value);
const clima=document.getElementById('clima').value;
const nomeProdutor=document.getElementById('nomeProdutor').value;
const nomeAgronomo=document.getElementById('nomeAgronomo').value;
const cidade=document.getElementById('cidade').value;
const municipio=document.getElementById('municipio').value;
const precoEnergia=parseFloat(document.getElementById('precoEnergia').value);

if([potenciaDisponivel,distancia,fileiras,comprimento,precoEnergia].some(isNaN)){
alert('Preencha todos os campos');
return;
}

// ===============================
// DADOS CULTURA (simplificado)
// ===============================
let vazaoPlanta=3.5;
let espacamento=0.5;

if(cultura==='tomate'){vazaoPlanta=4;espacamento=0.4;}
if(cultura==='alface'){vazaoPlanta=2;espacamento=0.3;}
if(cultura==='soja'){vazaoPlanta=2.5;espacamento=0.45;}
if(cultura==='feijao'){vazaoPlanta=2.8;espacamento=0.4;}

// ===============================
// CÁLCULOS AGRONÔMICOS
// ===============================
const plantasPorFileira=Math.floor(comprimento/espacamento);
const totalPlantas=plantasPorFileira*fileiras;

const vazaoTotal=totalPlantas*vazaoPlanta; // L/h
const vazao_m3h=vazaoTotal/1000;

// área aproximada
const espacamentoLinhas=0.8;
const area=fileiras*comprimento*espacamentoLinhas;

// ETc
const etc=etcEstimado(cultura,clima); // mm/dia
const volumeDia=(etc/1000)*area; // m³/dia

let tempoIrrigacao=volumeDia/vazao_m3h;
if(tempoIrrigacao<0.5) tempoIrrigacao=0.5;

// ===============================
// HIDRÁULICA
// ===============================
const diametro=escolherDiametro(vazao_m3h);
const perdaCarga=perdaCargaHazenWilliams(vazao_m3h,diametro,distancia);

// HMT realista
const HMT=12+perdaCarga+(distancia*0.01);

// potência considerando eficiência
const eficiencia=0.65;
const potenciaNecessaria=(vazao_m3h*HMT)/(75*eficiencia);

// seleção bomba
let bombaSugerida=`${Math.ceil(potenciaNecessaria)} CV`;

let metodoIrrigacao =
(cultura==='alface'||cultura==='tomate')?
"Gotejamento":"Aspersão";

// ===============================
// ENERGIA (CORRIGIDO)
// ===============================
const kW=potenciaNecessaria*0.7355;
const custoEnergia=(kW*tempoIrrigacao*30*precoEnergia).toFixed(2);

// ===============================
// RELATÓRIO
// ===============================
relatorioTexto=`Projeto de Irrigação - AgroCalc Pro

Produtor: ${nomeProdutor}
Engenheiro Agrônomo: ${nomeAgronomo}
Cidade: ${cidade} / ${municipio}

Cultura: ${cultura}
Total de plantas: ${totalPlantas}
Vazão total: ${Math.round(vazaoTotal)} L/h

--- Dimensionamento Hidráulico ---
Diâmetro principal calculado: ${diametro} mm PEAD
Perda de carga (Hazen-Williams): ${perdaCarga.toFixed(2)} mca
Altura manométrica total (HMT): ${HMT.toFixed(2)} mca
Potência hidráulica requerida: ${potenciaNecessaria.toFixed(2)} CV
Bomba sugerida: ${bombaSugerida}
Método recomendado: ${metodoIrrigacao}

--- Manejo de Irrigação ---
ETc estimada: ${etc.toFixed(2)} mm/dia
Tempo diário estimado: ${tempoIrrigacao.toFixed(2)} h/dia

--- Energia ---
Custo mensal estimado: R$ ${custoEnergia}

Obs: Valores para pré-dimensionamento. Validar curva real da bomba.`;

// mostrar
document.getElementById('resultadoTela').innerHTML=
relatorioTexto.replace(/\n/g,'<br>');
document.getElementById('appBox').classList.add('hidden');
document.getElementById('resultadoBox').classList.remove('hidden');
}

function voltarProjeto(){
document.getElementById('resultadoBox').classList.add('hidden');
document.getElementById('appBox').classList.remove('hidden');
}

async function gerarPDF(){
if(!relatorioTexto){alert('Calcule o projeto primeiro');return;}
const { jsPDF } = window.jspdf;
const doc=new jsPDF();
const linhas=doc.splitTextToSize(relatorioTexto,180);
doc.text(linhas,10,10);
doc.save('Projeto_Irrigacao_AgroCalc.pdf');
}
</script>